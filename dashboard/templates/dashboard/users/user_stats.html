<!DOCTYPE html>
{% load static %}
<html>
<head>
    <meta charset="utf-8">
    <title>User Stats</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'dashboard/css/styles.css' %}">
    <style>
      .card-block {
        background:#fff;
        border-radius:8px;
        box-shadow:0 2px 8px rgba(0,0,0,.05);
        padding:16px;
        margin-bottom:20px;
        font-size:14px;
      }
      .kpi-grid {
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
        gap:16px;
      }
      .kpi-card {
        background:#fff;
        border-radius:8px;
        border:1px solid #eee;
        box-shadow:0 2px 6px rgba(0,0,0,.04);
        padding:16px;
        display:flex;
        flex-direction:column;
        gap:6px;
      }
      .kpi-label {
        font-size:11px;
        font-weight:600;
        color:#555;
        text-transform:uppercase;
        letter-spacing:.03em;
      }
      .kpi-value {
        font-size:24px;
        font-weight:600;
        line-height:1.2;
        color:#222;
      }
      .kpi-hint {
        font-size:12px;
        color:#777;
        line-height:1.3;
      }

      .section-header {
        font-size:14px;
        font-weight:600;
        color:#222;
        display:flex;
        align-items:center;
        justify-content:space-between;
        flex-wrap:wrap;
        gap:8px;
        padding:0 16px 12px;
      }
      .section-header .meta {
        font-size:12px;
        font-weight:400;
        color:#777;
      }

      .table-wrap {
        overflow-x:auto;
        border-top:1px solid #eee;
      }
      table.stats-table {
        width:100%;
        border-collapse:collapse;
        font-size:14px;
      }
      table.stats-table thead th {
        text-align:left;
        border-bottom:2px solid #ddd;
        padding:10px;
        font-size:12px;
        font-weight:600;
        color:#555;
        text-transform:uppercase;
        letter-spacing:.03em;
        white-space:nowrap;
      }
      table.stats-table tbody td {
        border-bottom:1px solid #eee;
        padding:10px;
        vertical-align:top;
      }
      table.stats-table tbody tr:last-child td {
        border-bottom:none;
      }

      .text-right { text-align:right; }
      .muted {
        color:#777;
        font-size:12px;
      }
      .pill {
        display:inline-block;
        font-size:11px;
        font-weight:600;
        line-height:1.2;
        padding:3px 6px;
        border-radius:4px;
        margin-left:4px;
      }
      .pill-staff {
        background:#3498db22;
        color:#3498db;
        border:1px solid #3498db55;
      }
      .pill-super {
        background:#8e44ad22;
        color:#8e44ad;
        border:1px solid #8e44ad55;
      }
      .pill-banned {
        background:#e74c3c22;
        color:#e74c3c;
        border:1px solid #e74c3c55;
      }
      .btn-outline-back {
        color:#333;
        border:1px solid #ccc;
        background:#fff;
        border-radius:4px;
        padding:8px 12px;
        font-size:13px;
        font-weight:600;
        text-decoration:none;
        display:inline-block;
      }

      @media(max-width:700px){
        .section-header {
          flex-direction:column;
          align-items:flex-start;
        }
      }
    </style>
</head>
<body>
<div class="grid-container">

  {% include "dashboard/partials/header.html" %}
  {% include "dashboard/partials/sidebar.html" %}

  <main class="main-container">

      <!-- PAGE TITLE / ACTIONS -->
      <div class="main-title" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
          <h2>USER STATS</h2>

          <a href="{% url 'dashboard_user_list' %}"
             class="btn-outline-back">
             ← Back to Users
          </a>
      </div>

      <div style="font-size:13px;color:#777;margin-bottom:20px;">
        Snapshot generated at {{ now|date:"Y-m-d H:i" }}
      </div>

      <!-- KPI CARDS -->
      <section class="kpi-grid" style="margin-bottom:24px;">

        <div class="kpi-card">
          <div class="kpi-label">Total Users</div>
          <div class="kpi-value">{{ total_users }}</div>
          <div class="kpi-hint">All accounts</div>
        </div>

        <div class="kpi-card" style="border-left:4px solid #2ecc71;">
          <div class="kpi-label" style="color:#2ecc71;">Active (Not Banned)</div>
          <div class="kpi-value" style="color:#2ecc71;">{{ active_users }}</div>
          <div class="kpi-hint">Currently allowed to use the site</div>
        </div>

        <div class="kpi-card" style="border-left:4px solid #e74c3c;">
          <div class="kpi-label" style="color:#e74c3c;">Banned</div>
          <div class="kpi-value" style="color:#e74c3c;">{{ banned_users }}</div>
          <div class="kpi-hint">{{ banned_pct }}% of users are banned</div>
        </div>

        <div class="kpi-card" style="border-left:4px solid #3498db;">
          <div class="kpi-label" style="color:#3498db;">Staff</div>
          <div class="kpi-value" style="color:#3498db;">{{ staff_users }}</div>
          <div class="kpi-hint">Users with is_staff=True</div>
        </div>

        <div class="kpi-card" style="border-left:4px solid #8e44ad;">
          <div class="kpi-label" style="color:#8e44ad;">Superusers</div>
          <div class="kpi-value" style="color:#8e44ad;">{{ super_users }}</div>
          <div class="kpi-hint">Full admin access</div>
        </div>

        <div class="kpi-card" style="border-left:4px solid #000;">
          <div class="kpi-label" style="color:#000;">New (30d)</div>
          <div class="kpi-value" style="color:#000;">{{ new_last_30_days }}</div>
          <div class="kpi-hint">Joined in last 30 days</div>
        </div>

      </section>

      <!-- RECENT USERS -->
      <section class="card-block">
        <div class="section-header">
          <div>
            <div>Most Recent Users</div>
            <div class="meta">Latest 10 signups</div>
          </div>
        </div>

        <div class="table-wrap">
          <table class="stats-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Email</th>
                <th>Date Joined</th>
                <th class="text-right">Status</th>
              </tr>
            </thead>
            <tbody>
            {% if recent_users %}
              {% for u in recent_users %}
                <tr>
                  <td style="font-weight:600;color:#222;">
                    {{ u.username }}
                    {% if u.is_staff %}
                      <span class="pill pill-staff">staff</span>
                    {% endif %}
                    {% if u.is_superuser %}
                      <span class="pill pill-super">super</span>
                    {% endif %}
                  </td>
                  <td style="color:#444;">
                    {{ u.email|default:"—" }}
                  </td>
                  <td>
                    <div style="font-weight:600;color:#222;">
                      {{ u.date_joined|date:"Y-m-d" }}
                    </div>
                    <div class="muted">
                      {{ u.date_joined|date:"H:i" }}
                    </div>
                  </td>
                  <td class="text-right" style="font-weight:600;color:#222;">
                    {% if u.is_banned %}
                      <span class="pill pill-banned">BANNED</span>
                    {% else %}
                      <span class="muted">Active</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="4" style="text-align:center;color:#777;padding:20px;">
                  No users found.
                </td>
              </tr>
            {% endif %}
            </tbody>
          </table>
        </div>
      </section>

      <!-- STAFF BREAKDOWN -->
      <section class="card-block">
        <div class="section-header">
          <div>
            <div>Staff / Admin Breakdown</div>
            <div class="meta">How many privileged accounts exist</div>
          </div>
        </div>

        <div class="table-wrap">
          <table class="stats-table">
            <thead>
              <tr>
                <th>Role Flags</th>
                <th class="text-right"># Users</th>
              </tr>
            </thead>
            <tbody>
            {% if staff_breakdown %}
              {% for row in staff_breakdown %}
                <tr>
                  <td style="font-weight:600;color:#222;">
                    {% if row.is_superuser and row.is_staff %}
                      Superuser + Staff
                    {% elif row.is_superuser %}
                      Superuser only
                    {% elif row.is_staff %}
                      Staff (not superuser)
                    {% else %}
                      Regular user
                    {% endif %}
                  </td>
                  <td class="text-right" style="font-weight:600;color:#222;">
                    {{ row.user_count }}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="2" style="text-align:center;color:#777;padding:20px;">
                  No data.
                </td>
              </tr>
            {% endif %}
            </tbody>
          </table>
        </div>
      </section>

      <!-- BACK LINK -->
      <div style="text-align:right; margin-top:20px;">
        <a href="{% url 'dashboard_user_list' %}"
           class="btn-outline-back">
           ← Back to Users
        </a>
      </div>

  </main>
</div>
</body>
</html>
