<!DOCTYPE html>
{% load static %}
<html>
<head>
    <meta charset="utf-8">
    <title>Artwork Stats</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'dashboard/css/styles.css' %}">
    <style>
      .card-block {
        background:#fff;
        border-radius:8px;
        box-shadow:0 2px 8px rgba(0,0,0,.05);
        padding:16px;
        margin-bottom:20px;
        font-size:14px;
      }
      .kpi-grid {
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
        gap:16px;
      }
      .kpi-card {
        background:#fff;
        border-radius:8px;
        border:1px solid #eee;
        box-shadow:0 2px 6px rgba(0,0,0,.04);
        padding:16px;
        display:flex;
        flex-direction:column;
        gap:6px;
      }
      .kpi-label {
        font-size:11px;
        font-weight:600;
        color:#555;
        text-transform:uppercase;
        letter-spacing:.03em;
      }
      .kpi-value {
        font-size:24px;
        font-weight:600;
        line-height:1.2;
        color:#222;
      }
      .kpi-hint {
        font-size:12px;
        color:#777;
        line-height:1.3;
      }

      .section-header {
        font-size:14px;
        font-weight:600;
        color:#222;
        display:flex;
        align-items:center;
        justify-content:space-between;
        flex-wrap:wrap;
        gap:8px;
        padding:0 16px 12px;
      }
      .section-header .meta {
        font-size:12px;
        font-weight:400;
        color:#777;
      }

      .table-wrap {
        overflow-x:auto;
        border-top:1px solid #eee;
      }
      table.stats-table {
        width:100%;
        border-collapse:collapse;
        font-size:14px;
      }
      table.stats-table thead th {
        text-align:left;
        border-bottom:2px solid #ddd;
        padding:10px;
        font-size:12px;
        font-weight:600;
        color:#555;
        text-transform:uppercase;
        letter-spacing:.03em;
        white-space:nowrap;
      }
      table.stats-table tbody td {
        border-bottom:1px solid #eee;
        padding:10px;
        vertical-align:top;
      }
      table.stats-table tbody tr:last-child td {
        border-bottom:none;
      }

      .text-right { text-align:right; }
      .muted {
        color:#777;
        font-size:12px;
      }
      .btn-link {
        background:none;
        border:none;
        color:#3498db;
        font-size:12px;
        font-weight:600;
        text-decoration:none;
        padding:0;
        cursor:pointer;
      }
      .btn-outline-back {
        color:#333;
        border:1px solid #ccc;
        background:#fff;
        border-radius:4px;
        padding:8px 12px;
        font-size:13px;
        font-weight:600;
        text-decoration:none;
        display:inline-block;
      }

      .chart-card {
        background:#fff;
        border-radius:8px;
        border:1px solid #eee;
        box-shadow:0 2px 6px rgba(0,0,0,.04);
        padding:16px;
        margin-bottom:20px;
      }
      .chart-title {
        font-size:13px;
        font-weight:600;
        color:#222;
        margin-bottom:8px;
        display:flex;
        justify-content:space-between;
        flex-wrap:wrap;
        gap:6px;
      }
      .chart-sub {
        font-size:12px;
        color:#777;
      }

      @media(max-width:700px){
        .section-header {
          flex-direction:column;
          align-items:flex-start;
        }
      }
    </style>
</head>
<body>
<div class="grid-container">

  {% include "dashboard/partials/header.html" %}
  {% include "dashboard/partials/sidebar.html" %}

  <main class="main-container">

      <!-- PAGE TITLE / ACTIONS -->
      <div class="main-title" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
          <h2>ARTWORK STATS</h2>

          <a href="{% url 'dashboard_artwork_list' %}"
             class="btn-outline-back">
             ← Back to Artworks
          </a>
      </div>

      <div style="font-size:13px;color:#777;margin-bottom:20px;">
        Snapshot generated at {{ now|date:"Y-m-d H:i" }}
      </div>

      <!-- KPI CARDS -->
      <section class="kpi-grid" style="margin-bottom:24px;">

        <div class="kpi-card">
          <div class="kpi-label">Total Artworks</div>
          <div class="kpi-value">{{ total_artworks }}</div>
          <div class="kpi-hint">All records in the collection</div>
        </div>

        <div class="kpi-card" style="border-left:4px solid #2ecc71;">
          <div class="kpi-label" style="color:#2ecc71;">Visible</div>
          <div class="kpi-value" style="color:#2ecc71;">{{ visible_artworks }}</div>
          <div class="kpi-hint">Currently public / displayed</div>
        </div>

        <div class="kpi-card" style="border-left:4px solid #999;">
          <div class="kpi-label" style="color:#999;">Hidden</div>
          <div class="kpi-value" style="color:#999;">{{ hidden_artworks }}</div>
          <div class="kpi-hint">is_visible = False</div>
        </div>

        <div class="kpi-card" style="border-left:4px solid #3498db;">
          <div class="kpi-label" style="color:#3498db;">New (30 days)</div>
          <div class="kpi-value" style="color:#3498db;">{{ new_last_30_days }}</div>
          <div class="kpi-hint">Recently added artworks</div>
        </div>

        <div class="kpi-card" style="border-left:4px solid #8e44ad;">
          <div class="kpi-label" style="color:#8e44ad;">Avg Rating</div>
          <div class="kpi-value" style="color:#8e44ad;">{{ avg_rating }}</div>
          <div class="kpi-hint">Approved feedback only</div>
        </div>

        <div class="kpi-card" style="border-left:4px solid #000;">
          <div class="kpi-label" style="color:#000;">Feedback</div>
          <div class="kpi-value" style="color:#000;">{{ total_feedback }}</div>
          <div class="kpi-hint">{{ approved_feedback }} approved comments</div>
        </div>

      </section>

      <!-- CHARTS -->
      <section class="chart-card">
        <div class="chart-title">
          <div>
            Artworks by Year
            <div class="chart-sub">Top year / period labels (most frequent)</div>
          </div>
        </div>
        <canvas id="artworksByYearChart" height="120"></canvas>
      </section>

      <section class="chart-card">
        <div class="chart-title">
          <div>
            Feedback Volume (Last 14 Days)
            <div class="chart-sub">Daily total feedbacks received</div>
          </div>
        </div>
        <canvas id="feedbackTimelineChart" height="120"></canvas>
      </section>

      <!-- TOP RATED ARTWORKS -->
      <section class="card-block">
        <div class="section-header">
          <div>
            <div>Top Rated Artworks</div>
            <div class="meta">Sorted by average approved rating, then number of reviews</div>
          </div>
        </div>

        <div class="table-wrap">
          <table class="stats-table">
            <thead>
              <tr>
                <th>Artwork</th>
                <th class="text-right">Avg Rating</th>
                <th class="text-right"># Approved Reviews</th>
                <th class="text-right">Actions</th>
              </tr>
            </thead>
            <tbody>
            {% if top_rated_artworks %}
              {% for art in top_rated_artworks %}
                <tr>
                  <td style="font-weight:600;color:#222;">
                    {{ art.title }}
                    {% if art.artist %}
                      <div class="muted">{{ art.artist }}</div>
                    {% endif %}
                  </td>
                  <td class="text-right" style="font-weight:600;color:#222;">
                    {{ art.avg_rating|floatformat:2 }}
                  </td>
                  <td class="text-right" style="font-weight:600;color:#222;">
                    {{ art.approved_feedback_count }}
                  </td>
                  <td class="text-right">
                    <a class="btn-link"
                       href="{% url 'dashboard_artwork_edit' art.id %}">
                      edit artwork ›
                    </a>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="4" style="text-align:center;color:#777;padding:20px;">
                  No ratings yet.
                </td>
              </tr>
            {% endif %}
            </tbody>
          </table>
        </div>
      </section>

      <!-- MOST COMMENTED ARTWORKS -->
      <section class="card-block">
        <div class="section-header">
          <div>
            <div>Most Commented Artworks</div>
            <div class="meta">Total feedback (approved or pending)</div>
          </div>
        </div>

        <div class="table-wrap">
          <table class="stats-table">
            <thead>
              <tr>
                <th>Artwork</th>
                <th class="text-right"># Feedback</th>
                <th class="text-right">Moderation</th>
              </tr>
            </thead>
            <tbody>
            {% if most_commented_artworks %}
              {% for art in most_commented_artworks %}
                <tr>
                  <td style="font-weight:600;color:#222;">
                    {{ art.title }}
                    {% if art.artist %}
                      <div class="muted">{{ art.artist }}</div>
                    {% endif %}
                  </td>
                  <td class="text-right" style="font-weight:600;color:#222;">
                    {{ art.fb_count }}
                  </td>
                  <td class="text-right">
                    <a class="btn-link"
                       href="{% url 'dashboard_feedback_list' %}">
                      review feedback ›
                    </a>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="3" style="text-align:center;color:#777;padding:20px;">
                  No feedback yet.
                </td>
              </tr>
            {% endif %}
            </tbody>
          </table>
        </div>
      </section>

      <!-- BACK LINK -->
      <div style="text-align:right; margin-top:20px;">
        <a href="{% url 'dashboard_artwork_list' %}"
           class="btn-outline-back">
           ← Back to Artworks
        </a>
      </div>

  </main>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Pull chart data from Django (already safely JSON-encoded in context)
const ARTWORK_YEAR_LABELS = {{ chart_year_labels|safe }};
const ARTWORK_YEAR_COUNTS = {{ chart_year_counts|safe }};
const FEEDBACK_DAY_LABELS = {{ timeline_labels|safe }};
const FEEDBACK_DAY_COUNTS = {{ timeline_counts|safe }};

// Artworks by Year (bar)
const ctxYear = document.getElementById('artworksByYearChart').getContext('2d');
new Chart(ctxYear, {
    type: 'bar',
    data: {
        labels: ARTWORK_YEAR_LABELS,
        datasets: [{
            label: '# Artworks',
            data: ARTWORK_YEAR_COUNTS,
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                ticks: { precision:0 },
                beginAtZero: true
            }
        },
        plugins: {
            legend: { display: false }
        }
    }
});

// Feedback Volume over Last 14 Days (line)
const ctxTimeline = document.getElementById('feedbackTimelineChart').getContext('2d');
new Chart(ctxTimeline, {
    type: 'line',
    data: {
        labels: FEEDBACK_DAY_LABELS,
        datasets: [{
            label: 'Feedback / day',
            data: FEEDBACK_DAY_COUNTS,
            borderWidth: 2,
            tension: 0.3,
            pointRadius: 3
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                ticks: { precision:0 },
                beginAtZero: true
            }
        },
        plugins: {
            legend: { display: false }
        }
    }
});
</script>

<script src="{% static 'dashboard/js/scripts.js' %}"></script>
</body>
</html>
